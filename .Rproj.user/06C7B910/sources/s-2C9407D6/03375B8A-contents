---
title: "Analysis on World Happiness"
subtitle: ETC5513 Assignment 4
author: Yu Luo, Thakker Khushee, Yunqi Chen
output:
  bookdown::html_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache=FALSE, 
                      message=FALSE, 
                      warning=FALSE,
                      fig.width = 6, 
                      fig.height = 4,
                      fig.align="center")

# Libraries
library(tidyverse)
library(readxl)
library(kableExtra)
library(bookdown)
library(ggplot2)
library(plotly)
library(data.table)
library(stringr)      
library(janitor)
library(countrycode)

# Read the data
WHR20 <- read_excel("Data/WHR20_DataForFigure2.1.xls")
```

## Introduction

* Did you know countries are ranked each year based on a Happiness Index?

* Countries are ranked each year based on a **Happiness Index**. This index rates the happiness of countries on a scale from 0 to 10. Happiness index is also called the ladder score or the happiness score. <br>

* We have added a column for happiness rank. Happiness rank is given with respect to ladder score. The more the ladder score the higher the rank


## 1 Happiness Score by Region

* We have collected happiness data from World Happiness Report for 2020. It has global happiness that ranks 156 countries by how happy their citizens perceive themselves to be.

* We grouped the countries into different regions in the world to observe which region is the happiest.

* From the box plot \@ref(fig:region) we see that the happiness scores are quite different among these regions.

* The group determined that the **“happiest”** countries were located in **Western Europe**, particularly Finland and Denmark.

* Meanwhile the **“least happiest”** countries were located in **Sub-Saharan Africa** and **South Asia**. 


```{r include=FALSE}
happiness <- WHR20 %>% 
  select(`Country name`,`Regional indicator`,`Ladder score`,`Logged GDP per capita`,`Social support`,`Healthy life expectancy`,`Freedom to make life choices`,Generosity,`Perceptions of corruption`) %>% 
  mutate(`Happiness Rank` = rank(-`Ladder score`)) %>% 
  rename(`Happiness Score` = `Ladder score`) %>% clean_names()


```

```{r regiontable, include=FALSE}
reg_avg <- happiness %>%
  select(regional_indicator,happiness_score) %>%
  group_by(regional_indicator) %>%
  summarize(Average = mean(happiness_score)) %>% 
  arrange(-Average)

```

```{r countrycode, include=FALSE}
happiness$iso3 <- countrycode(happiness$country_name, 'country.name', 'iso3c')

happiness[happiness$country_name=="Kosovo","iso3"] <- "XKX"

```

```{r region, fig.cap = "Happiness Score by Region", fig.align='center',fig.height=5,fig.width=8}
plot_ly(happiness, x=~regional_indicator,
              y=~happiness_score,
              type="box",
              boxpoints="all",
              color=~regional_indicator,
        text = ~paste("<b>Region:</b> ", regional_indicator,
                      "<br><b>Country:</b> ", country_name,
                      "<br><b>Happiness Score:</b>", happiness_score))%>%
  layout(xaxis=list(showticklabels = FALSE),
         yaxis=list(title="Happiness Score"),
         legend=list(font = (size = 5)),
         margin=list(b = 100),
         title="Box Plot of Happiness Score by Region")
```



## GDP

Table \@ref(tab:GDP-ord) shows the average Logged GDP per capita of Regions from high to low. The top 3 regions with the highest GDP are North America and ANZ, Western Europe and East Asia, their GDP is all higher than 10. 

The average GDP for all the countries is `r mean(WHR20$"Logged GDP per capita")`, and we found three regions' average GDP are lower than this level: Sub-Saharan Africa, South Asia, Commonwealth of Independent States. We divided into two groups, the regions that regional average GDP higher than global, and regions with regional GDP lower than global, to see how is the relationship between the Logged GDP per capita and the Ladder Score of countries in these regions.

```{r GDP-ord}
gdp_mean <- WHR20 %>% 
  group_by(`Regional indicator`) %>% 
  summarise(Average 
            = round(mean(`Logged GDP per capita`),2))%>%
  arrange(-Average)

  gdp_mean %>% 
    kable(caption = "Average Logged GDP per capita of Regions from High to Low") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r GDP-dens, eval = FALSE}
ggplot(WHR20, aes(x = `Logged GDP per capita`))+
  geom_density()+
  geom_vline(aes(xintercept =
                   mean(`Logged GDP per capita`)),
             linetype = "dashed")

mean(WHR20$`Ladder score`)

mean(WHR20$`Logged GDP per capita`)

quantile(WHR20$`Logged GDP per capita`)
```

In Figure \@ref(fig:GDP-high), We found the countries in Western Europe and North America and ANZ, and most of the countries in East Asia and Central and Eastern Europe, have a higher score on either Ladder Score and GDP. In the Middle East and North Africa and South Asia, they are polarized, several countries are with high GDP and high Ladder Scores, several got low scores either on Ladder Score or GDP.

While what we found interesting and different from other Region is in Latin America and Caribbean, some countries even their GDP is lower than the average level, their Ladder Score is high. On the contrary, some countries in the Middle East and North Africa, they got higher GDP score, however, their Ladder Scores are low.

```{r GDP-high, fig.cap = "Ladder Score vs GDP for the Regions with Regional GDP Means Higher than Total Means"}
 WHR20 %>%
  filter(!`Regional indicator` %in% 
           c("Commonwealth of Independent States",
             "South Asia", 
             "Sub-Saharan Africa")) %>% 
  ggplot(aes(x = `Ladder score`, 
             y = `Logged GDP per capita`)) +
  geom_point() +
  geom_vline(aes(xintercept = 5.47324),
             linetype = "dashed") +
  geom_hline(aes(yintercept =9.295706),
             linetype = "dashed") +
  facet_wrap(~`Regional indicator`, ncol = 3)
```

Below Figure \@ref(fig:GDP-low) shows the regions whose regional GDP scores are lower than the average GDP of all the countries, it indicates most countries in these regions, their Ladder Scores are also lower.

```{r GDP-low, fig.height = 1.6, fig.cap = "Ladder Score vs GDP for the Regions with Regional GDP Means Lower than Total Means"}
 WHR20 %>%
  filter(`Regional indicator` %in% 
           c("Commonwealth of Independent States",
             "South Asia", 
             "Sub-Saharan Africa")) %>% 
  ggplot(aes(x = `Ladder score`, 
             y = `Logged GDP per capita`)) +
  geom_point() +
  geom_vline(aes(xintercept = 5.47324),
             linetype = "dashed") +
  geom_hline(aes(yintercept =9.295706),
             linetype = "dashed") +
  facet_wrap(~`Regional indicator`, ncol = 3)
```

## Social Support

The average Social Support of regions from high to low is shown in Table \@ref(tab:SS-ord).

The same method as GDP, we calculated the average Social Support of all counties, it is `r mean(WHR20$"Social support")`. 

```{r SS-ord}
SS_mean <- WHR20 %>% 
  group_by(`Regional indicator`) %>% 
  summarise(Average 
            = round(mean(`Social support`),2))%>%
  arrange(-Average)

  SS_mean %>% 
    kable(caption = "Average Social Support of Regions from High to Low") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r SS-dens, eval = FALSE}
ggplot(WHR20, aes(x = `Social support`))+
  geom_density()+
  geom_vline(aes(xintercept =
                   mean(`Social support`)),
             linetype = "dashed")

mean(WHR20$`Social support`)

quantile(WHR20$`Social support`)
```

Either the high Social Support group (shows in Figure \@ref(fig:SS-high)) or low Social Support group (Figure \@ref(fig:SS-low)), we nearly found no country has low Social Support score but got high Ladder Score. The relationship between Social Support and Ladder Score is close to a positive correlation. The better Social Support, the more possible it to get a better Ladder Score; on the opposite, as shown in Figure \@ref(fig:SS-low), the worse Social Support, the lower the Ladder Score. 

But not all the high score Social Support countries also got high Ladder Scores. In Central and Eastern Europe, Commonwealth of Independent States, Middle East and North Africa, South Asia, and Sub-Saharan Africa, some countries with high Social Support scores got low Ladder Scores.

```{r SS-high, fig.cap = "Ladder Score vs Social Support for the Regions with Regional Social Support Means Higher than Total Means"}
 WHR20 %>%
  filter(!`Regional indicator` %in% 
           c("Middle East and North Africa",
             "South Asia", 
             "Sub-Saharan Africa")) %>% 
  ggplot(aes(x = `Ladder score`, 
             y = `Social support`)) +
  geom_point() +
  geom_vline(aes(xintercept = 5.47324),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0.8087211),
             linetype = "dashed") +
  facet_wrap(~`Regional indicator`, ncol = 3)
```

```{r SS-low, fig.height = 1.6, fig.cap = "Ladder Score vs Social Suppor Lower than Total Means"}
 WHR20 %>%
  filter(`Regional indicator` %in% 
           c("Middle East and North Africa",
             "South Asia", 
             "Sub-Saharan Africa")) %>% 
  ggplot(aes(x = `Ladder score`, 
             y = `Social support`)) +
  geom_point() +
  geom_vline(aes(xintercept = 5.47324),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 0.8087211),
             linetype = "dashed") +
  facet_wrap(~`Regional indicator`, ncol = 3)
```

## Healthy Life Expectancy

Table \@ref(tab:HLE-ord) shows the ranking of Social Healthy Life Expectancy score of regions.

```{r HLE-ord}
HLE_mean <- WHR20 %>% 
  group_by(`Regional indicator`) %>% 
  summarise(Average 
            = round(mean(`Healthy life expectancy`),2))%>%
  arrange(-Average)

  HLE_mean %>% 
    kable(caption = "Healthy life expectancy") %>%
      kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r HLE-dens, eval = FALSE}
ggplot(WHR20, aes(x = `Healthy life expectancy`))+
  geom_density()+
  geom_vline(aes(xintercept =
                   mean(`Healthy life expectancy`)),
             linetype = "dashed")

mean(WHR20$`Healthy life expectancy`)

quantile(WHR20$`Healthy life expectancy`)
```

In the high Healthy Life Expectancy score countries group, it shows a positive correlation in Southeast Asia, Middle East and North Africa and North America and ANZ. But we found in the Commonwealth of Independent States, Central and Eastern Europe, Western Europe, some countries are almost at the same level of Healthy life Expectancy, their Ladder Scores arrange from a big difference. See that in Figure \@ref(fig:HLE-high).

```{r HLE-high, fig.cap = "Ladder Score vs Healthy Life Expectancy Higher than Total Means"}
 WHR20 %>%
  filter(!`Regional indicator` %in% 
           c("South Asia", 
             "Sub-Saharan Africa")) %>% 
  ggplot(aes(x = `Ladder score`, 
             y = `Healthy life expectancy`)) +
  geom_point() +
  geom_vline(aes(xintercept = 5.47324),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 64.44553),
             linetype = "dashed") +
  facet_wrap(~`Regional indicator`, ncol = 3)
```

Figure \@ref(fig:HLE-low) shows, in the low Healthy Life Expectancy region, they also have a low Ladder Score, while they don't look have a special relationship between Healthy Life Expectancy and Ladder Score. 

```{r HLE-low, fig.height = 1.6, fig.cap = "Ladder Score vs Healthy Life Expectancy Lower than Total Means"}
 WHR20 %>%
  filter(`Regional indicator` %in% 
           c("South Asia", 
             "Sub-Saharan Africa")) %>% 
  ggplot(aes(x = `Ladder score`, 
             y = `Healthy life expectancy`)) +
  geom_point() +
  geom_vline(aes(xintercept = 5.47324),
             linetype = "dashed") +
  geom_hline(aes(yintercept = 64.44553),
             linetype = "dashed") +
  facet_wrap(~`Regional indicator`, ncol = 3)
```


## Happiness score in differetent countries

* In the above sections we have seen factors that are reflect happiness score in different regions.
* In the this section we will look happiness score with respect to countries countries.

### Compare Top5, Middle5 and Worst5 Countries


```{r include=FALSE}
top5 <- happiness %>% head(5) %>% mutate(Level = "TOP5")
middle5 <- happiness[76:80, ] %>% mutate(Level = "MIDDLE5")
worst5 <- happiness %>% tail(5) %>% mutate(Level = "WORST5")

comparison <- bind_rows(top5, middle5, worst5)

comparison$Level <- as.factor(comparison$Level)
comparison <- transform(comparison, Level = factor(Level, levels = c("TOP5", "MIDDLE5", "WORST5" )))
```

```{r include=FALSE}

data.table(comparison,
          options = list(
            lengthMenu = c(5, 10, 15)
          ),
          caption = 
            htmltools::tags$caption(
              style = 'caption-side: bottom; text-align: center;', 
              htmltools::em('Data table that only includes top5, middle5 and worst5 countries'))
          )

```

```{r include=FALSE}
comparison.score <- comparison %>% rename("Economy GDP" = "logged_gdp_per_capita" , "Social Support" = "social_support" , "Health" = "healthy_life_expectancy", "Freedom" = "freedom_to_make_life_choices", "Corruption" ="perceptions_of_corruption") %>% 
  gather(key = "columns", value = "score", happiness_score:Corruption)

```


```{r compcount, fig.cap = "Compare top median and bottom five countries", fig.width=10}

comparison.score %>% 
  ggplot(aes(x = Level, y = score, colour = Level, fill = Level)) + 
  geom_boxplot(position=position_dodge(width=1)) + facet_wrap(~columns, scales = "free") 

```

+ In the above figure \@ref(fig:compcount), we have taken the top 5, middle 5 and the bottom 5 countries to understand the relations between 6 factors and happiness score. 
+ Country with higher happiness score have higher GDP. Happiest countries tend to be those with strong and stable economies.
+ Health is particular important because it directly affects individuals in countries.
* We observe that the countries with highest happiness score have a better GDP, less corruption, more freedom to make choices, good health ratio, more generosity and receive social support.
 


### Happiness Score for Countries


```{r map, fig.cap= "World Happiness Map", fig.width=8}

fig <- plot_ly(happiness, type='choropleth', locations= happiness$iso3 , z= happiness$happiness_score, text= ~paste(
                      "<br><b>Country:</b> ", country_name,
                      "<br><b>Happiness rank:</b>", happiness_rank), colorscale="Viridis")

fig <- fig %>% colorbar(title = "Happiness Score" )

fig <- fig %>% layout(
    title = 'World Happiness Map, Year 2020')
fig

```



+ The World Happiness report calculates how much of the Happiness Index can be explained by the key factors. Add them all up and you should get close to the actual number. <br>

+ From the below map \@ref(fig:map) you can easily spot the happiest country, Finland. <br>

+ Finland is ranked 1st according to the happiness score it has. It is said one of the reason why Finnish people are so happy is that they do not have to deal with corruption and black money. <br>

+ Countries such as Afghanistan and South Sudan have least happiness score, one one the possible reasons could be the wars happening there.


## Conclusion

This analysis illustrated that the world’s happiest countries are primarily in Western Europe, North America, and Australia & New Zealand, the countries in these regions got the higher Ladder Scores. 

The six factors included in the report: Logged GDP per capita, Social Support, Healthy Life Expectancy, Freedom to make life choices, Generosity, basically show a positive correlation between them and Ladder Scores. Most of the countries in high-factors regions got higher Ladder Scores than most of the countries in low-factors regions. But it is definitely a golden rule that once one country or region got high scores on these six factors, the country or region was the happiest one. We found many countries are in high-factor region countries and their factors are higher than some other countries, while their Ladder Score is lower than those countries. Also, we found in some regions, shows there perhaps is a relationship between the factors and Ladder Score, but in some regions, there is no relationship existing.

By analyzing these reports, we are able to decipher what makes countries and their citizens happier, thus allowing us to focus on prioritizing and improving these aspects of each country. It is through this that we are able to achieve the true pursuit of happiness, which we as human beings strive for.


## References

World Happiness Report. 2020. The World Happiness Report 2020. [online] Available at: https://worldhappiness.report/ed/2020/

Hadley Wickham and Jennifer Bryan (2019). readxl: Read Excel Files. R package version 1.3.1. https://CRAN.R-project.org/package=readxl

Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686

Sam Firke (2021). janitor: Simple Tools for Examining and Cleaning Dirty Data. R package version 2.1.0. https://CRAN.R-project.org/package=janitor

C. Sievert. Interactive Web-Based Data Visualization with R, plotly, and shiny. Chapman and Hall/CRC Florida, 2020.

Hao Zhu (2021). kableExtra: Construct Complex Table with 'kable' and Pipe Syntax. R package version 1.3.4. https://CRAN.R-project.org/package=kableExtra

Yihui Xie (2020). bookdown: Authoring Books and Technical Documents with R Markdown. R package version 0.21.

Yihui Xie (2016). bookdown: Authoring Books and Technical Documents with R Markdown. Chapman and Hall/CRC. ISBN 978-1138700109

H. Wickham. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York, 2016.

Hadley Wickham (2019). stringr: Simple, Consistent Wrappers for Common String Operations. R package version 1.4.0. https://CRAN.R-project.org/package=stringr

Arel-Bundock et al., (2018). countrycode: An R package to convert country names and country codes. Journal of Open Source Software, 3(28), 848, https://doi.org/10.21105/joss.00848